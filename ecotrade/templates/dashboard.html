{% extends 'base_dashboard.html' %}
{% block dashboard_content %}
<main class="flex-1 p-8 overflow-y-auto">
    {% if request.user.tipo_usuario == 'CO' %}
        <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-8"> Dashboard da Cooperativa </h2>
    {% elif request.user.tipo_usuario == 'CA' %}
        <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-8"> Dashboard do Catador </h2>
    {% else %}
        <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-8"> Dashboard da Empresa </h2>
    {% endif %}
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        <div class="bg-white dark:bg-background-dark p-6 rounded-xl shadow-sm">
            <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Volume Total de Resíduos Negociados (kg)
            </h3>
            <p class="text-3xl font-bold text-gray-800 dark:text-white mt-2"> {{ volume_total_residuos }}</p>
        </div>
        <div class="bg-white dark:bg-background-dark p-6 rounded-xl shadow-sm">
            <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Negociações Ativas</h3>
            <p class="text-3xl font-bold text-gray-800 dark:text-white mt-2"> {{ negociacoes_ativas }} </p>
        </div>
        {% if usuario.tipo_usuario == 'CO' %}
            <div class="bg-white dark:bg-background-dark p-6 rounded-xl shadow-sm">
                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Catadores Ativos</h3>
                <p class="text-3xl font-bold text-gray-800 dark:text-white mt-2"> {{ outras_infos.count_catadores }} </p>
            </div>
        {% elif usuario.tipo_usuario == 'CA' %}
            <div class="bg-white dark:bg-background-dark p-6 rounded-xl shadow-sm">
                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Rendimento Total</h3>
                <p class="text-3xl font-bold text-gray-800 dark:text-white mt-2"> {{ outras_infos.rendimento_total }} </p>
            </div>
        {% else %}
            <div class="bg-white dark:bg-background-dark p-6 rounded-xl shadow-sm">
                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Cooperativas Parceiras</h3>
                <p class="text-3xl font-bold text-gray-800 dark:text-white mt-2"> {{ outras_infos.cooperativas_unicas }}
                </p>
            </div>
        {% endif %}
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        {% load static %}
        <div class="bg-white dark:bg-background-dark p-6 rounded-xl shadow-sm">
            <h3 class="font-semibold text-gray-800 dark:text-white mb-4">Volume de Resíduos por Tipo</h3>
            {% if max_volume %}
            <div class="grid grid-cols-4 gap-4 items-end h-48">
                {% for tipo_residuo_key, volume in volume_por_residuo.items %}

                {% if volume > 0 and max_volume > 0 %}
                {% widthratio volume max_volume 100 as height_percentage %}
                {% else %}
                {% with 0 as height_percentage %}
                {% endwith %}
                {% endif %}

                <div class="flex flex-col items-center h-full justify-end">
                    <div class="w-full rounded-t
                        {% if forloop.counter|divisibleby:3 %}bg-primary{% else %}bg-primary/20{% endif %}" style="height: {{ height_percentage }}%"
                        title="{{ volume|floatformat:1 }} kg">
                    </div>
                    <span class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                        {{ tipo_residuo_key|capfirst }}
                    </span>
                </div>
                {% endfor %}
            </div>
            {% else %}
            {% endif %}
        </div>
        
       <div class="bg-white dark:bg-background-dark p-6 rounded-xl shadow-sm">
            <h3 class="font-semibold text-gray-800 dark:text-white mb-4">Negociações Concluídas por Mês</h3>
            {% with max_neg=max_negociacoes_mes|default:1 %}
            <div class="grid grid-cols-6 gap-2 items-end h-48 relative"> 
                {% if negociacoes_por_mes %}
                    {% for mes_datetime, count in negociacoes_por_mes.items %}                    
                        {% widthratio count max_neg 100 as height_percentage %}
                        
                        <div class="flex flex-col items-center h-full justify-end">
                            
                            {# Barra do gráfico #}
                            <div class="w-full rounded-t bg-green-500 hover:bg-green-600 transition-colors"
                                style="height: {{ height_percentage }}%"
                                title="{{ mes_datetime|date:'F/Y' }} - {{ count }} negociações">
                            </div>
                            
                            {# Rótulo do mês (ex: Jan) #}
                            <span class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                {{ mes_datetime|date:'M' }}
                            </span>
                        </div>
                    {% endfor %}
                {% else %}
                    {# Se a lista estiver vazia, exibe 6 barras vazias (exemplo para manter o layout) #}
                    <div class="col-span-6 flex justify-around h-full">
                        <p class="text-gray-500 dark:text-gray-400 self-center">Nenhuma negociação concluída neste período.</p>
                    </div>
                {% endif %}
                
                {# Linha de base do gráfico (Opcional, apenas visual) #}
                <div class="absolute bottom-0 left-0 right-0 h-px bg-gray-300 dark:bg-gray-700"></div>

            </div>
            {% endwith %}
        </div>
    </div>
</main>
{% endblock %}